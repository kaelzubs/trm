{% extends 'base.html' %}
{% load humanize %}
{% block title %}Cart{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="row">
    <!-- Cart Items -->
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h3 class="mb-0">Your Cart</h3>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered align-middle table-sm mb-0 w-100 cart-table">
              <thead class="thead-light">
                <tr>
                  <th>Product</th>
                  <th class="text-right">Price</th>
                  <th class="text-center">Qty</th>
                  <th class="text-right">Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for i in cart_items %}
                  <tr data-product-id="{{ i.product.id }}" data-unit-price="{{ i.price }}">
                    <td>{{ i.product.title }}</td>
                    <td class="text-right text-nowrap">₦{{ i.price|floatformat:2|intcomma }}</td>
                    <td class="text-center">
                      <input type="number" class="form-control form-control-sm qty-input" 
                             data-product-id="{{ i.product.id }}" 
                             min="1" 
                             value="{{ i.quantity }}" 
                             style="width: 70px;">
                    </td>
                    <td class="text-right text-nowrap line-total">₦{{ i.line_total|floatformat:2|intcomma }}</td>
                    <td class="text-center">
                      <a class="btn btn-sm btn-outline-danger"
                        href="{% url 'orders:cart_remove' i.product.id %}">
                        Remove
                      </a>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center text-muted py-4">
                      Your cart is empty.
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="p-3 bg-light">
            <button type="button" class="btn btn-sm btn-primary" id="update-cart-btn">
              Update Cart
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Summary -->
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">Order Summary</h5>
        </div>
        <div class="card-body">
          <p class="d-flex justify-content-between">
            <span><strong>Subtotal:</strong></span>
            <span id="subtotal-display">₦{{ totals.subtotal|floatformat:2|intcomma }}</span>
          </p>
          <p class="d-flex justify-content-between">
            <span><strong>Shipping:</strong></span>
            <span id="shipping-display">₦{{ totals.shipping|floatformat:2|intcomma }}</span>
          </p>
          <hr>
          <p class="d-flex justify-content-between font-weight-bold">
            <span>Total:</span>
            <span id="total-display">₦{{ totals.total|floatformat:2|intcomma }}</span>
          </p>
          <a class="btn btn-success btn-block mt-3"
             href="{% url 'orders:checkout' %}">
            Proceed to Checkout
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const baseShipping = parseFloat('{{ totals.shipping|floatformat:2 }}');

// Format currency with ₦ and comma separators
function formatCurrency(amount) {
  return '₦' + parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// Calculate subtotal from all quantity inputs
function calculateSubtotal() {
  let subtotal = 0;
  document.querySelectorAll('tr[data-product-id]').forEach(row => {
    const unitPrice = parseFloat(row.getAttribute('data-unit-price'));
    const qtyInput = row.querySelector('.qty-input');
    const qty = parseInt(qtyInput.value) || 0;
    subtotal += unitPrice * qty;
  });
  return subtotal;
}

// Update display totals on the page
function updateDisplayTotals() {
  const subtotal = calculateSubtotal();
  const shipping = baseShipping;
  const total = subtotal + shipping;
  
  document.getElementById('subtotal-display').textContent = formatCurrency(subtotal);
  document.getElementById('shipping-display').textContent = formatCurrency(shipping);
  document.getElementById('total-display').textContent = formatCurrency(total);
}

// Update line total for a specific product row
function updateLineTotalDisplay(row) {
  const unitPrice = parseFloat(row.getAttribute('data-unit-price'));
  const qtyInput = row.querySelector('.qty-input');
  const qty = parseInt(qtyInput.value) || 0;
  const lineTotal = unitPrice * qty;
  const lineTotalCell = row.querySelector('.line-total');
  lineTotalCell.textContent = formatCurrency(lineTotal);
}

// Update all line totals when quantities change
function updateAllLineTotals() {
  document.querySelectorAll('tr[data-product-id]').forEach(row => {
    updateLineTotalDisplay(row);
  });
  updateDisplayTotals();
}

// Handle quantity input changes (for live preview)
document.querySelectorAll('.qty-input').forEach(input => {
  input.addEventListener('input', function() {
    let newQty = parseInt(this.value);
    
    // Only update display if valid number
    if (!isNaN(newQty) && newQty > 0) {
      const row = this.closest('tr[data-product-id]');
      updateLineTotalDisplay(row);
      updateDisplayTotals();
    }
  });
  
  // Reset invalid values on blur
  input.addEventListener('blur', function() {
    let newQty = parseInt(this.value);
    if (isNaN(newQty) || newQty < 1) {
      this.value = 1;
      updateAllLineTotals();
    }
  });
});

// Update Cart button handler - send all quantities to server
document.getElementById('update-cart-btn')?.addEventListener('click', function() {
  const updates = [];
  let hasInvalidQty = false;
  
  document.querySelectorAll('.qty-input').forEach(input => {
    const productId = parseInt(input.getAttribute('data-product-id'));
    let newQty = parseInt(input.value);
    
    if (isNaN(newQty) || newQty < 1) {
      input.value = 1;
      newQty = 1;
      hasInvalidQty = true;
    }
    
    updates.push({
      product_id: productId,
      quantity: newQty
    });
  });
  
  if (updates.length === 0) {
    alert('Your cart is empty');
    return;
  }
  
  // Send all updates in a single request
  fetch(`{% url 'orders:update_cart_qty' %}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token }}'
    },
    body: JSON.stringify(updates)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload the page to reflect server state
      location.reload();
    } else {
      alert('Error updating cart: ' + (data.message || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to update cart');
  });
});
</script>
{% endblock %}